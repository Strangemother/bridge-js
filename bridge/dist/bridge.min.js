/*! bridge.min.js build:0.0.1, production. Copyright(c) 2011 Flotype <team@flotype.com> MIT Licensed */
function CallQueue(a){this._target=a,this.ready=!1,this.queue=[]}function Connection(){}function WebConnection(a,b,c){var d=this;this.onMessage=b,this.options=util.extend(defaultOptions,c),this.options.use_tcp?(console.log("TCP CONN",this.options.host,this.options.port),this.sock=createTCPConn(this.options)):this.sock=new SockJS(this.options.url,this.options.protocols,this.options.sockjs),this.sock.onopen=function(){d.clientId=d.sock._connid,console.log("CLIENT ID:",d.clientId),a()},this.sock.onmessage=d.onData.bind(d),this.sock.onclose=function(){util.warn("WebConnection closed")}}function Bridge(a){var b=this;this.children={},this.callQueue=new CallQueue(this),this.connection=new BridgeConnection(function(){util.info("Connected"),b.callQueue.process()},this.onMessage.bind(this),a),this.getPathObj=this.getPathObj.bind(this)}var log;window.console&&console.log?log=function(){console.log.apply(console,arguments)}:log=function(){};var util={hasProp:function(a,b){return Object.prototype.hasOwnProperty.call(Object(a),b)},extend:function(a,b){function d(){this.constructor=a}if(a===undefined||b===undefined)return a;for(var c in b)util.hasProp(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},generateGuid:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return""+a()+a()+a()+a()+a()+a()+a()+a()},typeOf:function(a){var b=typeof a;return b==="object"&&(a?typeof a.length=="number"&&!a.propertyIsEnumerable("length")&&typeof a.splice=="function"&&(b="array"):b="null"),b},getKeys:Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b},inherit:function(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c},stringify:JSON.stringify,parse:JSON.parse,log:log,error:function(){util.log.apply(this,arguments)},warn:function(){util.log.apply(this,arguments)},info:function(){util.log.apply(this,arguments)}};CallQueue.prototype.push=function(a,b){this.ready?a.apply(this._target,b):this.queue.push({callback:a,args:b})},CallQueue.prototype.process=function(){this.ready=!0;for(var a=0,b=this.queue.length;a<b;a++)this.queue[a].callback.apply(this._target,this.queue[a].args);this.queue=[]};var BridgeRef=function(a,b,c){function d(){var a=[].slice.apply(arguments);d.call.apply(d,a)}return d._fixops=function(){for(x in d._operations){var a=d._operations[x];console.log("FIXING",a),d[a]=d.get(a).call,d[a+"_e"]=d.get(a).call_e}},d.get=function(a){var a=a.split(".");return d._bridgeRoot.getPathObj(d._pathchain.concat(a))},d.call=function(){var a=[].slice.apply(arguments);return a.push(null),d.call_e.apply(d,a)},d.call_e=function(){var a=[].slice.apply(arguments),b=a.pop();return console.log("CALL_E",b,d._pathchain,a),d._bridgeRoot.funcCall(b,d,a)},d.getLocalName=function(){return d._pathchain[1]},d._getRef=function(a){return d._operations=a,d._fixops(),d},d.toDict=function(){return d._pathchain[0]=="local"&&(d._pathchain[0]=d._bridgeRoot.getClientId()),{ref:d._pathchain,operations:d._operations}},d._operations=c||[],d._bridgeRoot=a,d._pathchain=b,d._fixops(),d},BridgeSerialize={serialize:function(a,b,c){var d=util.typeOf(b),e;switch(d){case"object":var f=!1,g=[],h={};for(m in b){var i=b[m];m.indexOf("handle_")==0&&util.typeOf(i)=="function"?(h[m.substr(7)]=!0,f=!0):g.push(m)}h=util.getKeys(h),b._getRef&&util.typeOf(b._getRef)=="function"&&(f=!0);if(f){var j;b._getRef&&util.typeOf(b._getRef)=="function"?j=b._getRef():j=a.doPublishService(b);var k=j._getRef(h).toDict();c&&(c[k.ref.join(".")]=!0),e=["now",k]}else{var l={};for(pos in g){var m=g[pos],i=b[m];l[m]=BridgeSerialize.serialize(a,i,c)}e=["dict",l]}break;case"array":var l=[];for(pos in b){var i=b[pos];l.push(BridgeSerialize.serialize(a,i,c))}e=["list",l];break;case"string":e=["str",b];break;case"number":e=["float",b];break;case"function":var k;if(b._getRef&&util.typeOf(b._getRef)=="function")k=b._getRef().toDict();else{var n=function(){};n.handle_default=b;var j=a.doPublishService(n);k=j.toDict()}c&&(c[k.ref.join(".")]=!0),e=["now",k];break;case"null":e=["none",null];break;case"undefined":e=["none",null];break;case"boolean":e=["bool",b];break;default:util.warn("Unknown",b,d)}return e},unserialize:function(a,b){var c=b[0],d=b[1],e;switch(c){case"list":var f=[];for(pos in d)f.push(BridgeSerialize.unserialize(a,d[pos]));e=f;break;case"dict":var f={};for(pos in d)f[pos]=BridgeSerialize.unserialize(a,d[pos]);e=f;break;case"str":e=d;break;case"float":e=d;break;case"bool":e=Boolean(d);break;case"now":e=a.getPathObj(d.ref)._getRef(d.operations);break;case"none":e=null;break;default:util.warn("Unknown",d,c)}return e}};Connection.prototype.DEFAULT_EXCHANGE="T_DEFAULT",Connection.prototype.getQueueName=function(){return"C_"+this.clientId},Connection.prototype.getExchangeName=function(){return"T_"+this.clientId};var defaultOptions={url:"http://localhost:8080/now",use_tcp:!1};util.inherit(WebConnection,Connection),WebConnection.prototype.onData=function(a){var b=this;try{var a=util.parse(a.data);b.onMessage(a)}catch(c){util.error("Message parsing failed: ",c.message,c.stack)}},WebConnection.prototype.send=function(a,b){var c=BridgeSerialize.serialize(a,{command:"SEND",data:b});c=util.stringify(c),this.sock.send(c)},WebConnection.prototype.joinWorkerPool=function(a,b,c){util.info("Joining worker pool",b);var d={command:"JOINWORKERPOOL",data:{name:b,handler:a.getRootRef(),callback:c}};d=BridgeSerialize.serialize(a,d),d=util.stringify(d),this.sock.send(d)},WebConnection.prototype.joinChannel=function(a,b,c,d,e){var f={command:"JOINCHANNEL",data:{name:b,handler:d,callback:e}};f=BridgeSerialize.serialize(a,f),f=util.stringify(f),this.sock.send(f)};var BridgeConnection=WebConnection;Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),Bridge.prototype.onMessage=function(a){util.info("MESSAGE RECEIVED: ",JSON.stringify(a));var b=BridgeSerialize.unserialize(this,a),c=b.destination;if(!c){util.warn("NO DESTINATION IN MESSAGE, IGNORING");return}var d=b.destination._pathchain,e=b.args;d[0]!=this.getClientId()&&d[0]!="local"&&d.unshift(this.getClientId());var f=this.getPathObj(d);f.call.apply(f,e)},Bridge.prototype.executeLocal=function(a,b,c){var d=this;a.length==1&&!c?util.hasProp(this.children,a[0])?a.push("default"):a.unshift("default"):a.length==0?a=["default","default"]:a[0]==="named"&&(a[2]=="system"?a=["system",a[3],a[1]]:a.shift()),console.log("checking for system",a);if(a[0]==="system"){console.log("system message",a.slice(1),b[0]),a[1]=="hook_channel_handler"?(console.log("HOOK CHANNEL HANDLER",a,b[0],b[1]._getRef().toDict()),d.children["channel:"+b[0]]=d.children[b[1]._getRef()._pathchain[1]],b[2]&&b[2].call(d.getChannel(b[0]),b[0])):a[1]=="getservice"&&(console.log("getservice",a,b),b[0].call(this.children[a[2]]));return}var e=this.children[a[0]]||this.children["default"];if(!e)throw new Error("No registered handler and no Default Handler for "+a[0]+" !");var f;a[1]?f="handle_"+a[1]:f="handle_base",console.log("finding func for",a,"is",f);var g=e[f];if(!g){util.warn("No Handler for",a,"- trying default handler"),g=e.handle_default;var h=a[1]||"base";b.unshift(h)}g?g.apply(e,b):util.warn("No Func nor Default Handler for",a)},Bridge.prototype.executeSystem=function(a){util.info("Execute system",a)},Bridge.prototype.registerDefault=function(a,b){this.children["default"]=a,b&&b()},Bridge.prototype.publishService=function(a,b,c){this.callQueue.push(this.doPublishService,[a,b,c])},Bridge.prototype.joinChannel=function(a,b,c){this.callQueue.push(this.doJoinChannel,[a,b,c])},Bridge.prototype.doPublishService=function(a,b,c){var d=this;typeof a!="string"&&typeof a!="number"&&(b=a,a=undefined);var e=c;if(!b._getRef||util.typeOf(b._getRef)!="function")a?(b._getRef=function(){return d.getPathObj(["local",a])},this.connection.joinWorkerPool(d,a,e)):(a=util.generateGuid(),b._getRef=function(){return d.getPathObj(["local",a])});else{if(a)throw Error("Service can't be renamed! "+a+" old "+b._getRef().getLocalName());a=b._getRef().getLocalName()}return d.children[a]=b,b._getRef()},Bridge.prototype.doJoinChannel=function(a,b,c){var d=this;b||(b=this.getClientId());var e;if(typeof b!="string"&&typeof b!="number"){e=b;var f=BridgeSerialize.serialize(this,e);b=f[1].ref[0]}var g=c,h=null;e&&(h=e),d.connection.joinChannel(this,a,b,h,g)},Bridge.prototype.execute=function(a,b,c){b._pathchain[0]=="system"&&this.executeSystem(c);if(b._pathchain[0]==this.getClientId()||b._pathchain[0]=="local")b._pathchain[1]=="channel"?(console.log("local channel exec",b._pathchain),this.executeLocal(["channel:"+b._pathchain[2]].concat(b._pathchain.slice(3)),c,!0)):this.executeLocal(b._pathchain.slice(1),c);else{var d={args:c,destination:b,errcallback:a};this.connection.send(this,d)}},Bridge.prototype.funcCall=function(a,b,c){this.callQueue.push(this.execute,[a,b,c])},Bridge.prototype.ready=function(a){this.callQueue.push(a,[])},Bridge.prototype.getClientId=function(){return this.connection.clientId},Bridge.prototype.getPathObj=function(a){return new BridgeRef(this,a)},Bridge.prototype.getRootRef=function(){return this.getPathObj([this.getClientId()])},Bridge.prototype.get=function(a){var b=a.split(".");return this.getPathObj(b,!0)},Bridge.prototype.getService=function(a,b,c){this.getPathObj(["named",a,"system","getservice"]).call_e(b,c)},Bridge.prototype.getChannel=function(a){return this.getPathObj(["channel",a])}