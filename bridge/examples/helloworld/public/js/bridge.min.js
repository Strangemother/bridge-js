/*! bridge.min.js build:0.0.1, production. Copyright(c) 2011 Flotype <team@flotype.com> MIT Licensed */
function CallQueue(a){this._bridgeref=a,this.ready=!1,this.queue=[]}function Connection(){}function WebConnection(a,b,c){var d=this;this.onMessage=b,this.options=util.extend(defaultOptions,c),this.options.use_tcp?(console.log("TCP CONN",this.options.host,this.options.port),this.sock=createTCPConn(this.options)):this.sock=new SockJS(this.options.url,this.options.protocols,this.options.sockjs),this.sock.onopen=function(){d.clientId=d.sock._connid,console.log("CLIENT ID:",d.clientId),a()},this.sock.onmessage=d.onData.bind(d),this.sock.onclose=function(){util.warn("WebConnection closed")}}function Bridge(a){var b=this;this.children={},this.callQueue=new CallQueue(this),this.connection=new BridgeConnection(function(){util.info("Connected"),b.callQueue.process()},this.onMessage.bind(this),a)}var log;window.console&&console.log?log=function(){console.log.apply(console,arguments)}:log=function(){};var util={hasProp:function(a,b){return Object.prototype.hasOwnProperty.call(Object(a),b)},extend:function(a,b){function d(){this.constructor=a}if(a===undefined||b===undefined)return a;for(var c in b)util.hasProp(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},generateGuid:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return""+a()+a()+a()+a()+a()+a()+a()+a()},typeOf:function(a){var b=typeof a;return b==="object"&&(a?typeof a.length=="number"&&!a.propertyIsEnumerable("length")&&typeof a.splice=="function"&&(b="array"):b="null"),b},getKeys:Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b},inherit:function(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c},stringify:JSON.stringify,parse:JSON.parse,log:log,error:function(){util.log.apply(this,arguments)},warn:function(){util.log.apply(this,arguments)},info:function(){util.log.apply(this,arguments)}};CallQueue.prototype.push=function(a,b){this.ready?a.apply(this._bridgeref,b):this.queue.push({callback:a,args:b})},CallQueue.prototype.process=function(){this.ready=!0;for(var a=0,b=this.queue.length;a<b;a++)this.queue[a].callback.apply(this._bridgeref,this.queue[a].args);this.queue=[]};var BridgePath=function(a,b){function c(a){var b=a.split(".");return c.bridgeRoot.getPathObj(c.pathchain.concat(b))}return c.call=function(){var a=[].slice.apply(arguments);return c.call_e.apply(this,[null].concat(a))},c.call_e=function(a){var b=[].slice.apply(arguments);return c.bridgeRoot.funcCall(a,c,b.slice(1))},c.getLocalName=function(){return c.pathchain[1]},c.getRef=function(){return c.pathchain[0]=="local"&&(c.pathchain[0]=c.bridgeRoot.getClientId()),{ref:c.pathchain}},c.bridgeRoot=a,c.pathchain=b,c},BridgeSerialize={serialize:function(a,b,c){var d=util.typeOf(b),e;switch(d){case"object":if(b._bridgeRef){var f=b._bridgeRef.getRef();c&&(c[f.ref.join(".")]=!0),e=["now",f]}else{var g={},h=!1;for(pos in b){var i=b[pos];if(pos.indexOf("handle_")==0&&util.typeOf(i)=="function"){h=!0;break}g[pos]=BridgeSerialize.serialize(a,i,c)}if(h){var j=a.doPublishService(b),f=j.getRef();c&&(c[f.ref.join(".")]=!0),e=["now",f]}else e=["dict",g]}break;case"array":var g=[];for(pos in b){var i=b[pos];g.push(BridgeSerialize.serialize(a,i,c))}e=["list",g];break;case"string":e=["str",b];break;case"number":e=["float",b];break;case"function":var f;if(b.getRef)f=b.getRef();else{var k=function(){};k.handle_default=b;var j=a.doPublishService(k);f=j.getRef()}c&&(c[f.ref.join(".")]=!0),e=["now",f];break;case"null":e=["none",null];break;case"undefined":e=["none",null];break;case"boolean":e=["bool",b];break;default:util.warn("Unknown",b,d)}return e},unserialize:function(a,b){var c=b[0],d=b[1],e;switch(c){case"list":var f=[];for(pos in d)f.push(BridgeSerialize.unserialize(a,d[pos]));e=f;break;case"dict":var f={};for(pos in d)f[pos]=BridgeSerialize.unserialize(a,d[pos]);e=f;break;case"str":e=d;break;case"float":e=d;break;case"bool":e=Boolean(d);break;case"now":e=new BridgePath(a,d.ref);break;case"none":e=null;break;default:util.warn("Unknown",d,c)}return e}};Connection.prototype.DEFAULT_EXCHANGE="T_DEFAULT",Connection.prototype.getQueueName=function(){return"C_"+this.clientId},Connection.prototype.getExchangeName=function(){return"T_"+this.clientId};var defaultOptions={url:"http://localhost:8080/now",use_tcp:!1};util.inherit(WebConnection,Connection),WebConnection.prototype.onData=function(a){var b=this;try{util.info("hi",a,a.data);var a=util.parse(a.data);b.onMessage(a)}catch(c){util.error("Message parsing failed: ",c.message,c.stack)}},WebConnection.prototype.send=function(a,b){var c=BridgeSerialize.serialize(a,{command:"SEND",data:b});c=util.stringify(c),this.sock.send(c)},WebConnection.prototype.joinWorkerPool=function(a,b,c){util.info("Joining worker pool",b,c);var d={command:"JOINWORKERPOOL",data:{name:b,handler:a.getRootRef(),callback:c}};d=BridgeSerialize.serialize(a,d),d=util.stringify(d),this.sock.send(d)},WebConnection.prototype.joinChannel=function(a,b,c,d){var e=util.stringify({type:"JOINCHANNEL",name:a,handler:c,callback:d});this.sock.send(e)};var BridgeConnection=WebConnection;Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),Bridge.prototype.getPathObj=function(a){return new BridgePath(this,a)},Bridge.prototype.getRootRef=function(){return new BridgePath(this,[this.connection.clientId],!1)},Bridge.prototype.onMessage=function(a){var b=BridgeSerialize.unserialize(this,a),c=b.destination;util.info("Message received: ",b,c.pathchain);if(!c){util.warn("NO DESTINATION IN MESSAGE, IGNORING");return}var d=b.destination.pathchain,e=b.args;d[0]!=this.getClientId()&&d[0]!="local"&&d.unshift(this.getClientId());var f=new BridgePath(this,d);f.call.apply(null,e)},Bridge.prototype.getClientId=function(){return this.connection.clientId},Bridge.prototype.executeLocal=function(a,b){var c=this;a.length==1?util.hasProp(this.children,a[0])?a.push("default"):a.unshift("default"):a.length==0?a=["default","default"]:a[0]==="named"&&a.shift();if(a[0]==="system"){console.log("system message",a.slice(1),b[0]),a[1]=="hook_channel_handler"&&(console.log("HOOK CHANNEL HANDLER",a,b[0],b[1].getRef()),c.children["channel:"+b[0]]=c.children[b[1].getRef().ref[1]],b[2]&&b[2].call(c.getChannel(b[0]),b[0]));return}var d=this.children[a[0]]||this.children["default"];if(!d)throw new Error("No registered handler and no Default Handler for "+a[0]+" !");var e="handle_"+a[1],f=d[e];f||(f=d.handle_default,b.unshift(a[1])),f?f.apply(d,b):util.warn("No Handler for",a)},Bridge.prototype.executeSystem=function(a){util.info("Execute system",a)},Bridge.prototype.registerDefault=function(a,b){this.children["default"]=a,b&&b()},Bridge.prototype.publishService=function(a,b,c){this.callQueue.push(this.doPublishService,[a,b,c])},Bridge.prototype.joinChannel=function(a,b,c){this.callQueue.push(this.doJoinChannel,[a,b,c])},Bridge.prototype.doPublishService=function(a,b,c){typeof a!="string"&&typeof a!="number"&&(b=a,a=undefined);var d=c;if(!b._bridgeRef)a?this.connection.joinWorkerPool(this,a,d):a=util.generateGuid(),b._bridgeRef=new BridgePath(this,["local",a]);else{if(a)throw Error("Service can't be renamed! "+a+" old "+b._bridgeRef.getLocalName());a=b._bridgeRef.getLocalName()}return this.children[a]=b,b._bridgeRef},Bridge.prototype.doJoinChannel=function(a,b,c){var d=this;b||(b=this.getClientId());var e;if(typeof b!="string"&&typeof b!="number"){e=b;var f=BridgeSerialize.serialize(this,e);b=f[1].ref[0]}var g=c,h=null;e&&(h=e),d.connection.joinChannel(a,b,h,g)},Bridge.prototype.execute=function(a,b,c){b.pathchain[0]=="system"&&this.executeSystem(commandArgs);if(b.pathchain[0]==this.getClientId()||b.pathchain[0]=="local")b.pathchain[1]=="channel"?this.executeLocal(["channel:"+b.pathchain[2]].concat(b.pathchain.slice(3)),c):this.executeLocal(b.pathchain.slice(1),c);else{var d={args:c,destination:b};this.connection.send(this,d)}},Bridge.prototype.funcCall=function(a,b,c){this.callQueue.push(this.execute,[a,b,c])},Bridge.prototype.ready=function(a){this.callQueue.push(a,[])},Bridge.prototype.get=function(a){var b=a.split(".");return this.getPathObj(b,!0)},Bridge.prototype.getService=function(a){return this.getPathObj(["named",a])},Bridge.prototype.getClient=function(a){return this.getPathObj([a],!1)},Bridge.prototype.getChannel=function(a){return this.getPathObj(["channel",a])}