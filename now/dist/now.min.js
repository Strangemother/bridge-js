/*! now.min.js build:0.0.1, production. Copyright(c) 2011 Flotype <team@flotype.com> MIT Licensed */
function CallQueue(a){this.ready=!1,this.queue=[],this.callback=a}var log=console.log,util={hasProp:function(a,b){return Object.prototype.hasOwnProperty.call(Object(a),b)},extend:function(a,b){function d(){this.constructor=a}if(a===undefined||b===undefined)return a;for(var c in b)util.hasProp(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},generateGuid:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return""+a()+a()+a()+a()+a()+a()+a()+a()},typeOf:function(a){var b=typeof a;return b==="object"&&(a?typeof a.length=="number"&&!a.propertyIsEnumerable("length")&&typeof a.splice=="function"&&(b="array"):b="null"),b},getKeys:Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b},stringify:JSON.stringify,parse:JSON.parse,log:log,error:log,warn:log,info:log};CallQueue.prototype.onReady=function(){this.ready=!0,this.process()},CallQueue.prototype.push=function(){this.queue.push([].slice.apply(arguments)),this.ready&&this.process()},CallQueue.prototype.process=function(){var a=this.queue;this.queue=[];for(var b in a)this.callback.apply(null,a[b])};var NowPath=function(a,b,c){function d(){var a=arguments[0].split(".");return d.nowRoot.getPathObj(d.pathChain.concat(a),d.named)}return d.call=function(){var a=[].slice.apply(arguments);d.nowRoot.funcCall(d.pathChain,d.named,a)},d.getLocalName=function(){return d.pathChain[1]},d.getRef=function(){return d.pathChain[0]=="local"&&(d.pathChain[0]=d.nowRoot.getClientId()),{ref:d.pathChain}},d.nowRoot=a,d.pathChain=b,d.named=c,d},NowSerialize={serialize:function(a,b,c){var d=util.typeOf(b),e;switch(d){case"object":if(b._nowRef){var f=b._nowRef.getRef();c[f.ref[0]]=!0,e=["now",f]}else{var g={};for(pos in b){var h=b[pos];g[pos]=NowSerialize.serialize(a,h,c)}e=["list",g]}break;case"array":var g=[];for(pos in b){var h=b[pos];g.push(NowSerialize.serialize(a,h,c))}e=["list",g];break;case"string":e=["str",b];break;case"number":e=["float",b];break;case"function":var f;if(b.getRef)f=b.getRef();else{var i=function(){};i.handle_remote_call=b;var j=a.doRegisterService(i);f=j.getRef()}c[f.ref[0]]=!0,e=["now",f];break;case"null":e=["none",null];break;default:util.warn("Unknown",b,d)}return e},unserialize:function(a,b){var c=b[0],d=b[1],e;switch(c){case"list":var f=[];for(pos in d)f.push(NowSerialize.unserialize(a,d[pos]));e=f;break;case"dict":var f={};for(pos in d)f[pos]=NowSerialize.unserialize(a,d[pos]);e=f;break;case"str":e=d;break;case"float":e=d;break;case"now":e=new NowPath(a,d.ref);break;case"none":break;default:util.warn("Unknown",d,c)}return e}},Now=function(){function a(b){var c=b.split(".");return a.getPathObj(c,!0)}return a.getPathObj=function(b,c){return new NowPath(a,b,c)},a.onMessage=function(b){util.info("Message received: ",b);var c=b.pathChain;c[0]!=a.getClientId()&&c[0]!="local"&&c.unshift(a.getClientId());var d=b.serargskwargs,e=NowSerialize.unserialize(a,["list",d[0]]),f=NowSerialize.unserialize(a,["dict",d[1]]),g=new NowPath(a,c);g.call.apply(null,e)},a.getClientId=function(){return a.connection.clientId},a.executeLocal=function(b){var c=b[0],d=b[1],e=a.children[c[0]];c.length>1||c.push("remote_call");var f=e["handle_"+c[1]];f?f.apply(e,d):util.warn("No Handler",c)},a.executeSystem=function(a){util.info("Execute system",a)},a.registerService=function(b,c){a.callQueue.push("register_service",b,c)},a.doRegisterService=function(b,c){return b._nowRef?c?util.error("Service can't be renamed!"):c=b._nowRef.getLocalName():(c?a.connection.joinWorkerPool(c):c=util.generateGuid(),b._nowRef=new NowPath(a,["local",c])),a.children[c]=b,b._nowRef},a.execute=function(b){var c=b[0],d=b[1],e=b[2];c[0]=="system"&&a.executeSystem(e);if(c[0]==a.getClientId()||c[0]=="local")a.executeLocal([c.slice(1),e]);else{var f={},g=[NowSerialize.serialize(a,e,f)[1],{}],h={serargskwargs:g,pathChain:c};if(d)var i="N."+c[0];else var i=c[0];a.connection.send(i,util.stringify(h),util.getKeys(f))}},a.queueCallback=function(){var b=[].slice.apply(arguments);b[0]=="execute"?a.execute(b.slice(1)):b[0]=="register_service"?a.doRegisterService(b[1],b[2]):util.warn("UNKNOWN QUEUED COMMAND")},a.funcCall=function(b,c,d){a.callQueue.push("execute",b,c,d)},a.callQueue=new CallQueue(a.queueCallback),a.connection=new NowConnection(function(){util.info("Connected"),a.callQueue.onReady()},a.onMessage),a.children={},a}