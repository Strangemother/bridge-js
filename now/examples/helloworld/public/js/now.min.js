/*! now.min.js build:0.0.1, production. Copyright(c) 2011 Flotype <team@flotype.com> MIT Licensed */
function CallQueue(a){this._nowref=a,this.ready=!1,this.queue=[]}function Connection(){}function WebConnection(a,b,c){var d=this;this.onMessage=b,this.options=util.extend(defaultOptions,c),use_tcp?(console.log("TCP CONN",this.options.host,this.options.port),this.sock=createTCPConn(this.options)):this.sock=new SockJS(this.options.url,this.options.protocols,this.options.sockjs),this.sock.onopen=function(){d.clientId=d.sock._connid,a()},this.sock.onmessage=d.onData.bind(d),this.sock.onclose=function(){util.warn("WebConnection closed")}}function Now(a){var b=this;this.children={},this.callQueue=new CallQueue(this),this.connection=new NowConnection(function(){util.info("Connected"),b.callQueue.process()},this.onMessage.bind(this),a)}var log;window.console&&console.log?log=function(){console.log.apply(console,arguments)}:log=function(){};var util={hasProp:function(a,b){return Object.prototype.hasOwnProperty.call(Object(a),b)},extend:function(a,b){function d(){this.constructor=a}if(a===undefined||b===undefined)return a;for(var c in b)util.hasProp(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},generateGuid:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return""+a()+a()+a()+a()+a()+a()+a()+a()},typeOf:function(a){var b=typeof a;return b==="object"&&(a?typeof a.length=="number"&&!a.propertyIsEnumerable("length")&&typeof a.splice=="function"&&(b="array"):b="null"),b},getKeys:Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b},inherit:function(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c},stringify:JSON.stringify,parse:JSON.parse,log:log,error:function(){},warn:function(){},info:function(){}};CallQueue.prototype.push=function(a,b){this.ready?a.apply(this._nowref,b):this.queue.push({callback:a,args:b})},CallQueue.prototype.process=function(){this.ready=!0;for(var a=0,b=this.queue.length;a<b;a++)this.queue[a].callback.apply(this._nowref,this.queue[a].args);this.queue=[]};var NowPath=function(a,b,c){function d(a){var b=a.split(".");return d.nowRoot.getPathObj(d.pathchain.concat(b),d.named)}return d.call=function(){var a=[].slice.apply(arguments);d.nowRoot.funcCall(d.pathchain,d.named,a)},d.getLocalName=function(){return d.pathchain[1]},d.getRef=function(){return d.pathchain[0]=="local"&&(d.pathchain[0]=d.nowRoot.getClientId()),{ref:d.pathchain}},d.nowRoot=a,d.pathchain=b,d.named=c,d},NowSerialize={serialize:function(a,b,c){var d=util.typeOf(b),e;switch(d){case"object":if(b._nowRef){var f=b._nowRef.getRef();c[f.ref.join(".")]=!0,e=["now",f]}else{var g={},h=!1;for(pos in b){var i=b[pos];if(pos.indexOf("handle_")==0&&util.typeOf(i)=="function"){h=!0;break}g[pos]=NowSerialize.serialize(a,i,c)}if(h){var j=a.doJoinService(b),f=j.getRef();c[f.ref.join(".")]=!0,e=["now",f]}else e=["dict",g]}break;case"array":var g=[];for(pos in b){var i=b[pos];g.push(NowSerialize.serialize(a,i,c))}e=["list",g];break;case"string":e=["str",b];break;case"number":e=["float",b];break;case"function":var f;if(b.getRef)f=b.getRef();else{var k=function(){};k.handle_default=b;var j=a.doJoinService(k);f=j.getRef()}c[f.ref.join(".")]=!0,e=["now",f];break;case"null":e=["none",null];break;case"undefined":e=["none",null];break;case"boolean":e=["bool",b];break;default:util.warn("Unknown",b,d)}return e},unserialize:function(a,b){var c=b[0],d=b[1],e;switch(c){case"list":var f=[];for(pos in d)f.push(NowSerialize.unserialize(a,d[pos]));e=f;break;case"dict":var f={};for(pos in d)f[pos]=NowSerialize.unserialize(a,d[pos]);e=f;break;case"str":e=d;break;case"float":e=d;break;case"bool":e=Boolean(d);break;case"now":e=new NowPath(a,d.ref);break;case"none":e=null;break;default:util.warn("Unknown",d,c)}return e}};Connection.prototype.DEFAULT_EXCHANGE="T_DEFAULT",Connection.prototype.getQueueName=function(){return"C_"+this.clientId},Connection.prototype.getExchangeName=function(){return"T_"+this.clientId};var defaultOptions={url:"http://localhost:8080/now"};util.inherit(WebConnection,Connection),WebConnection.prototype.onData=function(a){var b=this;try{var a=util.parse(a.data);b.onMessage(a)}catch(c){util.error("Message parsing failed: ",c.message,c.stack)}},WebConnection.prototype.send=function(a,b,c){util.info("Sending",a,b,c);var d={};for(x in c)d["link_"+x]=c[x];this.sock.send(util.stringify({message:b,routingKey:a,headers:d}))},WebConnection.prototype.joinWorkerPool=function(a){util.info("Joined worker pool",a),this.sock.send(util.stringify({type:"joinWorkerPool",name:a}))},WebConnection.prototype.joinChannel=function(a){this.sock.send(util.stringify({type:"joinChannel",name:a}))};var NowConnection=WebConnection;Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),Now.prototype.getPathObj=function(a,b){return new NowPath(this,a,b)},Now.prototype.onMessage=function(a){util.info("Message received: ",a);var b=a.pathchain;b[0]!=this.getClientId()&&b[0]!="local"&&b.unshift(this.getClientId());var c=NowSerialize.unserialize(this,["list",a.args]),d=new NowPath(this,b);d.call.apply(null,c)},Now.prototype.getClientId=function(){return this.connection.clientId},Now.prototype.executeLocal=function(a,b){var c=this;a.length==1?util.hasProp(this.children,a[0])?a.push("default"):a.unshift("default"):a.length==0&&(a=["default","default"]);if(a[0]==="system"){console.log("system message",a.slice(1),b[0]),a[1]=="hook_channel_handler"&&(c.children["channel:"+b[0]]=c.children[b[1].getRef().ref[1]]);return}var d=this.children[a[0]]||this.children["default"];if(!d)throw new Error("No registered handler and no Default Handler!");var e=d["handle_"+a[1]];e?e.apply(d,b):util.warn("No Handler",a)},Now.prototype.executeSystem=function(a){util.info("Execute system",a)},Now.prototype.joinService=function(a,b){this.callQueue.push(this.doJoinService,[a,b])},Now.prototype.joinChannel=function(a,b,c){this.callQueue.push(this.doJoinChannel,[a,b,c])},Now.prototype.doJoinService=function(a,b){typeof a!="string"&&typeof a!="number"&&(b=a,a=undefined);if(!b._nowRef)a?this.connection.joinWorkerPool(a):a=util.generateGuid(),b._nowRef=new NowPath(this,["local",a]);else{if(a)throw Error("Service can't be renamed! "+a+" old "+b._nowRef.getLocalName());a=b._nowRef.getLocalName()}return this.children[a]=b,b._nowRef},Now.prototype.doJoinChannel=function(a,b,c){var d=this;b||(b=this.getClientId());if(typeof b!="string"&&typeof b!="number"){c=b;var e={},f=NowSerialize.serialize(this,c,e);b=f[1].ref[0]}c&&!d.connection.SUPPORTS_JOIN_CALLBACK&&(d.children["channel:"+a]=c),d.connection.joinChannel(a,b,function(a){console.log("JOIN CALLBACK SUCCEEDED",a);if(c&&d.connection.SUPPORTS_JOIN_CALLBACK)if(b==d.getClientId())d.children["channel:"+a]=c;else{var e=[a,c],f=[b,"system","hook_channel_handler"],g={},h=NowSerialize.serialize(d,e,g)[1],i={args:h,pathchain:f};d.connection.send("C_"+b,util.stringify(i),util.getKeys(g),!0)}})},Now.prototype.execute=function(a,b,c){a[0]=="system"&&this.executeSystem(commandArgs);if(a[0]==this.getClientId()||a[0]=="local")a[1]=="channel"?this.executeLocal(["channel:"+a[2]].concat(a.slice(3)),c):this.executeLocal(a.slice(1),c);else{var d={},e=NowSerialize.serialize(this,c,d)[1],f={args:e,pathchain:a};if(b)var g="N."+a.join(".");else var g=a.join(".");this.connection.send(g,util.stringify(f),util.getKeys(d),!1)}},Now.prototype.funcCall=function(a,b,c){this.callQueue.push(this.execute,[a,b,c])},Now.prototype.ready=function(a){this.callQueue.push(a,[])},Now.prototype.get=function(a){var b=a.split(".");return this.getPathObj(b,!0)},Now.prototype.getService=function(a){return this.getPathObj([a],!0)},Now.prototype.getClient=function(a){return this.getPathObj([a],!1)},Now.prototype.getChannel=function(a){return this.getPathObj(["channel",a],!1)}